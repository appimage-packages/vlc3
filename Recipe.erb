########################################################################
# TODO:
# j-b on #videolan:
# Ubuntu 14.04 is the oldest version supported by VLC 3
# <j-b> use extras/tools;
# <j-b> use contribs (for alsa)
# <j-b> use contribs with --disable to disable bluray
# <j-b> don't disable cddb
# <j-b> don't compile with gcc 4.9 but 6.1
# <j-b> don't build with Qt4, but qith qt5
# <j-b> once this is done, we can retalk :0
########################################################################
## Set env variables
#Needed to export all possible pkgconfig paths to prevent pkgconfig failures in tools and contribs.
export PKG_CONFIG_PATH=/usr/lib/pkgconfig:/vlc/contrib/x86_64-linux-gnu/lib/pkgconfig:/usr/share/pkgconfig:$PKG_CONFIG_PATH
export ACLOCAL_PATH=/usr/share/aclocal:$ACLOCAL_PATH
# Build failures without this, putting at top for consistancy
export CFLAGS=-fPIC

ARCH=$(arch)
APP=<%= name %>
VERSION=3.0.0-git
export DEBIAN_FRONTEND=noninteractive

# Install what we can via packages
sudo apt-get update && sudo apt-get -y upgrade
sudo apt-get -y install  autoconf cvs libxcb-shm0-dev libxcb-xv0-dev libxcb-composite0-dev libxcb-randr0-dev \
libx11-xcb-dev libxcb-image0-dev gzip libopenvg1-mesa-dev software-properties-common \
libxcb-icccm4-dev libxcb-sync0-dev libxcb-xfixes0-dev libxrender-dev libxcb-shape0-dev libxcb-randr0-dev \
libxcb-render-util0-dev libxcb-glx0-dev libgtk-3-dev libdbus-1-dev libgtk2.0-dev libsystemd-daemon-dev \
liblivemedia-dev libdc-dev libraw-dev libavc1394-dev libgdk-pixbuf2.0-dev shared-mime-info \
libopencv-dev libsmbclient-dev libfreerdp-dev libshine-dev libgstreamer1.0-dev libva-x11-1 libva-drm1  \
libvdpau-dev python3-dev libprojectm-dev libavahi-client-dev libncurses5-dev libmtp-dev libudev-dev \
libsecret-1-dev libnotify-dev

# Don't use ubuntu libtool as it is too old.
# Workaround for
# autoreconf: running: automake --add-missing --copy --force-missing
# configure.ac:7: error: must install xorg-macros 1.12 or later before running autoconf/autogen
# configure.ac:7: the top level
# autom4te: /usr/bin/m4 failed with exit status: 1
# aclocal: error: echo failed with exit status: 1
# autoreconf: aclocal failed with exit status: 1
# make: *** [.xproto] Error 1

cd /usr/src
wget http://ftp.x.org/pub/individual/util/util-macros-1.19.0.tar.bz2
tar -jxvf util-macros-1.19.0.tar.bz2
cd util-macros-1.19.0
./configure --prefix /usr
make install

# Workaround for contrib qt needing xcb
cd /usr/src
wget http://xcb.freedesktop.org/dist/xcb-proto-1.12.tar.bz2
tar -jxvf xcb-proto-1.12.tar.bz2
cd xcb-proto-1.12
./configure --prefix=/usr
make -j8
make install

cd /usr/src
wget http://xcb.freedesktop.org/dist/libxcb-1.12.tar.bz2
tar -jxvf libxcb-1.12.tar.bz2
cd libxcb-1.12
sed -i "s/pthread-stubs//" configure
./configure --prefix=/usr \
            --enable-xinput   \
            --without-doxygen
make
make install

cd /usr/src
wget http://xcb.freedesktop.org/dist/xcb-util-keysyms-0.4.0.tar.bz2
tar -jxvf xcb-util-keysyms-0.4.0.tar.bz2
cd xcb-util-keysyms-0.4.0
./configure --prefix=/usr
make -j8
make install

cd /usr/src
wget http://ftp.x.org/pub/individual/lib/libXdmcp-1.1.2.tar.bz2
tar -jxvf libXdmcp-1.1.2.tar.bz2
cd libXdmcp-1.1.2
./configure --prefix=/usr
make -j8
make install

########################################################################
# Get VLC
########################################################################

cd /
git clone git://git.videolan.org/vlc.git --depth 1
cd vlc

#Workaround
#mv /vlc/contrib/x86_64-linux-gnu/plugins/platforms/libqwindows.a /vlc/contrib/x86_64-linux-gnu/lib/ && rm -rf /vlc/contrib/x86_64-linux-gnu/plugins
#mv: cannot stat '/vlc/contrib/x86_64-linux-gnu/plugins/platforms/libqwindows.a': No such file or directory
#make: *** [.qt] Error 1
#make: *** Waiting for unfinished jobs..
sed -i '/libqwindows.a/d' contrib/src/qt/rules.mak
########################################################################
# To-be-built packages: autoconf automake cmake yasm ragel protoc ant
########################################################################

# Workaround for:
# Connecting to cmake.org (cmake.org)|66.194.253.19|:443... connected.
# ERROR: no certificate subject alternative name matches
# 	requested host name `cmake.org'.
# To connect to cmake.org insecurely, use `--no-check-certificate'.
echo "check_certificate = off" > $HOME/.wgetrc

# Add tools to the path/lib
export PATH=/vlc/extras/tools/build/bin:$PATH
export LD_LIBRARY_PATH=/vlc/extras/tools/build/lib:$LD_LIBRARY_PATH

cd extras/tools/
./bootstrap
make -j 8

cd ../..

########################################################################
# Install newer versions of some build-time dependencies
# These need to be enabled or disabled at bootstrap. Unfortunately, these do NOT
# build in any logical order and therefore dependency chains are broken and I had to build
# them outside contribs.
########################################################################

# Workaround for:
# Getting warning about outdated gettext
# Update gettext to 0.19.6
cd /usr/src
wget -c -T 10 ftp://ftp.gnu.org/gnu/gettext/gettext-0.19.7.tar.gz
tar xvf gettext-0.19.7.tar.gz
cd gettext-0.19.7
./configure --prefix=/usr    \
            --disable-static
make -j 8 && make install
chmod -v 0755 /usr/lib/preloadable_libintl.so

cd /vlc

########################################################################
# The "Contrib" method.
# If the libraries are not provided by your distribution,
# you may be better off linking VLC with them statically.
########################################################################
export PATH=/vlc/extras/tools/build/bin/:/vlc/contrib/x86_64-linux-gnu/bin:$PATH
export LD_LIBRARY_PATH=/vlc/extras/tools/build/lib:/vlc/contrib/x86_64-linux-gnu/lib:$LD_LIBRARY_PATH


########################################################################
#  Bootstrap
# Should say:
# "vlc aliases : cvlc rvlc qvlc svlc"
# Don't proceed if qvlc is not listed.
########################################################################

cd contrib
mkdir native
cd native
../bootstrap --disable-iconv --enable-xau --disable-bluray --disable-xcb --disable-cddb --enable-lua \
--enable-libdsm --enable-mfx --enable-fluidlite --disable-aribb25 --enable-jack --enable-fluid \
--enable-soxr --enable-qt
make -j 8

cd ../..

########################################################################
# These are the failed contribs done manually
# Most of them failed due to depending on another contrib and there was no method
# that I could find to force build order.
########################################################################

#libcdio too old
cd /usr/src
wget http://ftp.gnu.org/gnu/libcdio/libcdio-0.93.tar.bz2
tar -jxvf libcdio-0.93.tar.bz2
cd libcdio-0.93
./configure --prefix=/usr
make -j8
make install

cd /usr/src
wget https://sourceforge.net/projects/libcddb/files/libcddb/1.3.2/libcddb-1.3.2.tar.bz2
tar -jxvf libcddb-1.3.2.tar.bz2
cd libcddb-1.3.2
./configure --prefix=/usr
make -j8
make install

cd /usr/src
wget ftp://ftp.alsa-project.org/pub/lib/alsa-lib-1.1.1.tar.bz2
tar -jxvf alsa-lib-1.1.1.tar.bz2
cd alsa-lib-1.1.1
./configure --prefix=/usr
make -j8
make install


# librsvg stack is entirely broken
# Disable whole librsvg stack as contribs disables glib in harfbuzz despite librsvg
# depending on pango witch require hb-glib.h

# cd /usr/src
# wget http://ftp.gnome.org/pub/gnome/sources/libcroco/0.6/libcroco-0.6.11.tar.xz
# tar -xvf libcroco-0.6.11.tar.xz
# cd libcroco-0.6.11
# ./configure --prefix=/usr
# make -j8
# make install
#
# cd /usr/src
# wget http://cairographics.org/releases/pixman-0.34.0.tar.gz
# tar -xvzf pixman-0.34.0.tar.gz
# cd pixman-0.34.0
# ./configure --prefix=/usr
# make -j8
# make install
#
# cd /usr/src
# wget http://cairographics.org/releases/cairo-1.14.6.tar.xz
# tar -xvf  cairo-1.14.6.tar.xz
# cd cairo-1.14.6
# ./configure --prefix=/usr
# make -j8
# make install
#
# cd /usr/src
# wget http://ftp.gnome.org/pub/gnome/sources/pango/1.40/pango-1.40.1.tar.xz
# tar -xvf pango-1.40.1.tar.xz
# cd pango-1.40.1
# ./configure --prefix=/usr
# make -j8
# make install
#
# cd /usr/src
# wget http://ftp.gnome.org/pub/gnome/sources/librsvg/2.40/librsvg-2.40.16.tar.xz
# tar -xvf librsvg-2.40.16.tar.xz
# cd librsvg-2.40.16
# ./configure --prefix=/usr \
#                   --disable-introspection
# make -j8
# make install

#Workaround
#mv /vlc/contrib/x86_64-linux-gnu/plugins/platforms/libqwindows.a /vlc/contrib/x86_64-linux-gnu/lib/ && rm -rf /vlc/contrib/x86_64-linux-gnu/plugins
#mv: cannot stat '/vlc/contrib/x86_64-linux-gnu/plugins/platforms/libqwindows.a': No such file or directory
#make: *** [.qt] Error 1
#make: *** Waiting for unfinished jobs..

# QT_VERSION=5.6.0
# QVERSION_SHORT=5.6
# QTV=5.6.0
# cd /usr/src
# wget https://download.qt.io/official_releases/qt/5.6/$(QT_VERSION)/submodules/qtbase-opensource-src-$(QT_VERSION).tar.xz
# tar xvf qt-everywhere-opensource-src-${QT_VERSION}.tar.xz
# cd qt-everywhere-opensource-src-$QTV
# ./configure -v -static -release -opensource -confirm-license -no-pkg-config \
# 	-no-sql-sqlite -no-gif -qt-libjpeg -no-openssl -no-opengl -no-dbus \
# 	-no-qml-debug -no-audio-backend -no-sql-odbc \
#             -no-compile-examples -nomake examples
# make -j8
# make install

########################################################################
# GCC6
# Cannot use new gcc6 on extra-tools to ragel failure http://osdir.com/ml/general/2016-01/msg26911.html
# contribs also had many gcc6 failures. So only building vlc itself with gcc6 as requested.
########################################################################

sudo add-apt-repository --yes ppa:ubuntu-toolchain-r/test
sudo apt-get update
sudo apt-get --yes install  gcc-6 g++-6
sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-6 60 --slave /usr/bin/g++ g++ /usr/bin/g++-6

########################################################################
# Build VLC itself
########################################################################
cd /vlc

./bootstrap
./configure --disable-chromaprint --disable-bluray --enable-alsa=true \
--prefix=/usr

make -j 8

make install

########################################################################
# Build complete
# Now creating the AppDir
########################################################################
wget -q https://github.com/probonopd/AppImages/raw/master/functions.sh -O ./functions.sh
. ./functions.sh

cd /

cp /usr/share/applications/vlc.desktop .
sed -i -e "s|Exec=.*|Exec=vlc|g" vlc.desktop
sed -i -e "s|Icon=.*|Icon=vlc.png|g" vlc.desktop
cp /usr/share/icons/hicolor/48x48/apps/vlc.png .
get_desktopintegration vlc


APPDIR=VLC
mkdir -p /$APPDIR/$APP.AppDir
cd  /$APPDIR/$APP.AppDir
get_apprun
mv /vlc.* .
mkdir -p ./usr/lib/qt5/; mv /usr/lib/x86_64-linux-gnu/qt5/plugins $_
mkdir -p ./usr/share/vlc; mv /usr/share/vlc $_
mkdir -p ./usr/share/icons/hicolor; mv /usr/share/icons/hicolor $_
mkdir -p ./usr/share/applications; mv /usr/share/applications $_
mkdir -p ./usr/share/mime; mv /usr/share/mime $_
mkdir -p ./usr/share/locale; mv /usr/share/locale $_
mkdir -p ./usr/share/locale-langpack; mv /usr/share/locale-langpack $_


export LD_LIBRARY_PATH=./usr/lib/:$LD_LIBRARY_PATH

#functions.sh moves them to same location? But only sometimes, I don't get it.
copy_deps2()
{
 cd  /$APPDIR/$APP.AppDir/
  FILES=$(find . -type f -executable -or -name *.so.* -or -name *.so | sort | uniq )
  for FILE in $FILES ; do
    ldd "${FILE}" | grep "=>" | awk '{print $3}' | xargs -I '{}' echo '{}' >> DEPSFILE
  done
  DEPS=$(cat DEPSFILE | sort | uniq)
  for FILE in $DEPS ; do
    FILE=$FILE | tr -d .
    if [ -e $FILE ] ; then
      cp -v --parents -rfL $FILE   ./
    fi
  done
  rm -f DEPSFILE
}
copy_deps2 ; copy_deps2 ; copy_deps2 # Three runs to ensure we catch indirect ones
delete_blacklisted
patch_usr
mkdir -p ./usr/bin; mv /usr/bin/*vlc* $_
mkdir -p ./usr/lib/vlc; mv /usr/lib/vlc $_
mkdir -p ./usr/lib/vlc/plugins; mv /usr/lib/vlc/plugins $_
mv /usr/lib/libvlc* ./usr/lib/

# We don't bundle the developer stuff
rm -rf usr/include || true
rm -rf usr/lib/cmake || true
rm -rf usr/lib/pkgconfig || true
rm -rf ./usr/share/doc/vlc/libvlc/ || true
find /$APPDIR/$APP.AppDir/usr/lib/ -name '*.la' | xargs -i rm {}
strip usr/bin/* usr/lib/* usr/lib/vlc/plugins/*/* || true

########################################################################
# AppDir complete
# Now packaging it as an AppImage
########################################################################
cd /$APPDIR
rm /out/* || true
generate_appimage
